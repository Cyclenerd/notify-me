name: Push latest Docker image

on:
  push:
    branches: [ master ]

jobs:

  github-registry-latest:
    name: Push latest image to GitHub container registry
    runs-on: ubuntu-latest
    needs: [docker]
    steps:
      - name: Login to GitHub Container registry 🏭
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull latest test image from GitHub container registry 📦
        run: docker pull ghcr.io/cyclenerd/notify-me:test
      - name: Quick test 📏
        run: docker run ghcr.io/cyclenerd/notify-me:test test.pl --version
      - name: Push image to GitHub container registry as latest version 🚢
        run: |
          docker tag ghcr.io/cyclenerd/notify-me:test ghcr.io/cyclenerd/notify-me:latest
          docker push ghcr.io/cyclenerd/notify-me:latest

  docker-hub-latest:
    name: Push latest image to Docker Hub registry
    runs-on: ubuntu-latest
    needs: [docker]
    steps:
      - name: Login to Docker Hub registry 🏭
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_REGISTRY_PASSWORD }}
      - name: Pull latest test image from GitHub container registry 📦
        run: docker pull ghcr.io/cyclenerd/notify-me:test
      - name: Quick test 📏
        run: docker run ghcr.io/cyclenerd/notify-me:test test.pl --version
      - name: Push image to Docker Hub registry as latest version 🚢
        run: |
          docker tag ghcr.io/cyclenerd/notify-me:test cyclenerd/notify-me:latest
          docker push cyclenerd/notify-me:latest